(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};ABM.Mouse=function(){function e(e,s){this.model=e,this.callback=s,this.delegateMouseOverAndOutEvents=t(this.delegateMouseOverAndOutEvents,this),this.delegateDragEvents=t(this.delegateDragEvents,this),this.computeEventTypes=t(this.computeEventTypes,this),this.handleMouseEvent=t(this.handleMouseEvent,this),this.handleStep=t(this.handleStep,this),this.handleMouseMove=t(this.handleMouseMove,this),this.handleMouseUp=t(this.handleMouseUp,this),this.handleMouseDown=t(this.handleMouseDown,this),this.lastX=1/0,this.lastY=1/0,this.div=this.model.div,this.lastAgentsHovered=[],this.draggingAgents=[],this.start()}return e.prototype.start=function(){return this.div.addEventListener("mousedown",this.handleMouseDown,!1),document.body.addEventListener("mouseup",this.handleMouseUp,!1),this.div.addEventListener("mousemove",this.handleMouseMove,!1),this.model.on("step",this.handleStep),this.lastX=this.lastY=this.x=this.y=this.pixX=this.pixY=0/0,this.moved=this.down=!1},e.prototype.stop=function(){return this.div.removeEventListener("mousedown",this.handleMouseDown,!1),document.body.removeEventListener("mouseup",this.handleMouseUp,!1),this.div.removeEventListener("mousemove",this.handleMouseMove,!1),this.model.off("step",this.handleStep),this.lastX=this.lastY=this.x=this.y=this.pixX=this.pixY=0/0,this.moved=this.down=!1},e.prototype.handleMouseDown=function(t){return this.down=!0,this.moved=!1,this.handleMouseEvent(t)},e.prototype.handleMouseUp=function(t){return this.down=!1,this.moved=!1,this.handleMouseEvent(t)},e.prototype.handleMouseMove=function(t){return this.setXY(t),this.moved=!0,this.handleMouseEvent(t)},e.prototype.handleStep=function(){return isNaN(this.x)?void 0:this.delegateMouseOverAndOutEvents(this.x,this.y)},e.prototype.handleMouseEvent=function(t){var e;return e=this.computeEventTypes(),this.delegateEventsToAllAgents(e,t),null!=this.callback?this.callback(t):void 0},e.prototype.setXY=function(t){var e;return this.lastX=this.x,this.lastY=this.y,this.pixX=t.offsetX,this.pixY=t.offsetY,e=this.model.patches.pixelXYtoPatchXY(this.pixX,this.pixY),this.x=e[0],this.y=e[1],this.dx=this.lastX-this.x,this.dy=this.lastY-this.y},e.prototype.computeEventTypes=function(){var t;return t=[],this.down&&!this.moved&&t.push("mousedown"),this.down||this.moved||t.push("mouseup"),this.down&&this.moved&&(this.dragging||t.push("dragstart"),this.dragging=!0),!this.down&&this.dragging&&(this.dragging=!1,this.dragEnd=!0),this.moved&&t.push("mousemove"),t},e.prototype.delegateEventsToAllAgents=function(t,e){var s;return s=this.delegateEventsToAgentsAtPoint(t,this.x,this.y,e),s||(s=this.delegateEventsToLinksAtPoint(t,this.x,this.y,e)),s||this.delegateEventsToPatchAtPoint(t,this.x,this.y,e),this.delegateDragEvents(this.x,this.y,e),this.delegateMouseOverAndOutEvents(this.x,this.y,e)},e.prototype.delegateEventsToPatchAtPoint=function(t,e,s,i){var n,h,o,d,r;for(n=this.model.patches.patch(e,s),r=[],o=0,d=t.length;d>o;o++)h=t[o],r.push(this.emitAgentEvent(h,n,this.mouseEvent(n,i)));return r},e.prototype.delegateEventsToAgentsAtPoint=function(t,e,s,i){var n,h,o,d,r,a,u,l,v,g,p,m;for(h=this.model.patches.patch(e,s),p=h.n.concat(h),r=0,l=p.length;l>r;r++)for(o=p[r],m=o.agentsHere(),a=0,v=m.length;v>a;a++)if(n=m[a],n.hitTest(e,s)){for(u=0,g=t.length;g>u;u++)d=t[u],this.emitAgentEvent(d,n,this.mouseEvent(n,i));return n}},e.prototype.delegateEventsToLinksAtPoint=function(t,e,s,i){var n,h,o,d,r,a,u,l;for(l=this.model.links,d=0,a=l.length;a>d;d++)if(n=l[d],n.hitTest(e,s)){for(h=this.mouseEvent(n,i),r=0,u=t.length;u>r;r++)o=t[r],this.emitAgentEvent(o,n,h);return n}},e.prototype.emitAgentEvent=function(t,e,s){return"dragstart"===t&&this.draggingAgents.push(e),e.breed.emit(t,s),null!=e.breed.mainSet?e.breed.mainSet.emit(t,s):void 0},e.prototype.delegateDragEvents=function(t,e,s){var i,n,h,o,d;for(d=this.draggingAgents,h=0,o=d.length;o>h;h++)i=d[h],n=this.mouseEvent(i,s),this.moved&&this.emitAgentEvent("drag",i,n),this.dragEnd&&this.emitAgentEvent("dragend",i,n);return this.dragEnd?(this.draggingAgents=[],this.dragEnd=!1):void 0},e.prototype.delegateMouseOverAndOutEvents=function(t,e,s){var i,n,h,o,d,r,a,l,v,g,p,m,c;for(o={},h=[],r=this.model.patches.patch(t,e),h=u.clone(this.model.links),c=r.n.concat(r),l=0,g=c.length;g>l;l++)a=c[l],h=h.concat(a.agentsHere());for(v=0,p=h.length;p>v;v++)i=h[v],i.hitTest(t,e)&&(null==o[m=i.breed.name]&&(o[m]={}),o[i.breed.name][i.id]=i,this.lastAgentsHovered[i.breed.name]&&i.id in this.lastAgentsHovered[i.breed.name]||this.emitAgentEvent("mouseover",i,this.mouseEvent(i,s)));for(d in this.lastAgentsHovered)for(n in this.lastAgentsHovered[d])o[d]&&n in o[d]||(i=this.lastAgentsHovered[d][n],this.emitAgentEvent("mouseout",i,this.mouseEvent(i,s)));return this.lastAgentsHovered=o},e.prototype.mouseEvent=function(t,e){return{target:t,patchX:this.x,patchY:this.y,dx:this.dx,dy:this.dy,originalEvent:e}},e}()}).call(this);